#!/bin/sh

STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)
STAGED_FILES_CSV=$(echo "$STAGED_FILES" | tr '\n' ',' | sed 's/,$//')
TIMESTAMP=$(date +%Y%m%d-%H%M%S) && readonly TIMESTAMP
CONTAINER_NAME="megalinter-precommit-$TIMESTAMP"

cleanup() {
  printf '\n\n[HUSKY: PRE-COMMIT] Aborted\n'
  docker kill "$CONTAINER_NAME" >/dev/null 2>&1 || true
  exit 130
}

trap cleanup INT TERM

if [ -z "$STAGED_FILES" ]; then
  echo "[HUSKY: PRE-COMMIT] No staged files to lint"
  exit 0
fi

echo "[HUSKY: PRE-COMMIT] Running SecretLint on staged files..."
echo "$STAGED_FILES" | xargs ./node_modules/.bin/secretlint

echo "[HUSKY: PRE-COMMIT] Running MegaLinter on staged files..."
docker run --rm -t --sig-proxy --name "$CONTAINER_NAME" \
  -v "$(pwd)":/tmp/lint \
  -e MEGALINTER_FILES_TO_LINT="$STAGED_FILES_CSV" \
  -e MEGALINTER_CONFIG=.mega-linter.lint.yaml \
  -e REPORT_OUTPUT_FOLDER="/tmp/lint/logs/commit/megalinter/${TIMESTAMP}" \
  oxsecurity/megalinter:v9 &

DOCKER_PID=$!
wait $DOCKER_PID

echo "[HUSKY: PRE-COMMIT] Linting successful"
